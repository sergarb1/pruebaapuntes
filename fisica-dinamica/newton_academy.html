<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Newton's Academy: Aero-Physics Lab</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.70.0/phaser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #020617; overflow: hidden; touch-action: none; user-select: none; }
        #game-div { width: 100vw; height: 100vh; }
    </style>
</head>
<body>
<div id="game-div"></div>
<script>

// --- CONSTANTES DE DISE√ëO ---
const C = {
    BG: 0x020617,
    SHIP: 0x22d3ee,   // Cyan
    VEL: 0x4ade80,    // Verde
    FORCE: 0xf43f5e,  // Rojo
    GRID: 0x1e293b,
    WHITE: 0xffffff
};

// --- PREGUNTAS DID√ÅCTICAS ---
const QUESTIONS = [
    { q: "1¬™ LEY (INERCIA): ¬øQu√© le ocurre a un objeto en movimiento si la fuerza neta es CERO?", options: ["Se para inmediatamente", "Mantiene su velocidad y direcci√≥n", "Acelera"], ok: 1, expl: "Sin fuerzas externas, el objeto mantiene su estado actual por inercia.", tip: "‚ö†Ô∏è CUIDADO: En la Tierra el rozamiento es la fuerza que suele parar las cosas.", gold: "REGLA: F=0 => a=0." },
    { q: "2¬™ LEY: Si aplicas la misma fuerza a una pelota de tenis y a una de bolos...", options: ["La de tenis acelera m√°s", "La de bolos acelera m√°s", "Aceleran igual"], ok: 0, expl: "A menor masa, mayor aceleraci√≥n para una misma fuerza aplicada.", tip: "‚ö†Ô∏è CUIDADO: Masa y aceleraci√≥n son inversamente proporcionales.", gold: "REGLA: a = F / m." },
    { q: "3¬™ LEY: Si un nadador empuja el agua hacia atr√°s con sus manos...", options: ["El agua se mueve y ya est√°", "El agua empuja al nadador adelante", "El nadador se hunde"], ok: 1, expl: "Toda acci√≥n genera una reacci√≥n de igual magnitud y sentido opuesto.", tip: "‚ö†Ô∏è CUIDADO: Las fuerzas act√∫an en cuerpos diferentes (manos y agua).", gold: "REGLA: Acci√≥n y Reacci√≥n." },
    { q: "PESO: ¬øCu√°l es el peso de un objeto de 10kg en la Tierra (g=9.8)?", options: ["10 N", "98 N", "1 kg"], ok: 1, expl: "Peso = Masa x Gravedad. P = 10 * 9.8 = 98 N.", tip: "‚ö†Ô∏è CUIDADO: El peso es una fuerza (Newtons), la masa es materia (kg).", gold: "REGLA: P = m ¬∑ g." },
    { q: "ROZAMIENTO: ¬øHacia d√≥nde apunta la fuerza de fricci√≥n?", options: ["Hacia el centro de la Tierra", "En sentido opuesto al deslizamiento", "Hacia donde nos movemos"], ok: 1, expl: "El rozamiento siempre intenta frenar el movimiento entre superficies.", tip: "‚ö†Ô∏è CUIDADO: Depende de la rugosidad y del peso, no del √°rea.", gold: "REGLA: Fr = Œº ¬∑ N." }
];

// --- ESCENA DE INICIO ---
class BootScene extends Phaser.Scene {
    constructor() { super('BootScene'); }
    create() {
        // DISE√ëO DE COHETE (Puntero al Eje X / Derecha)
        let g = this.make.graphics({x:0, y:0, add:false});
        
        // Cuerpo Cono S√≥lido
        g.fillStyle(C.SHIP);
        g.beginPath();
        g.moveTo(40, 0);    // Punta (Derecha)
        g.lineTo(-20, -15); // Base Arriba
        g.lineTo(-12, 0);   // Hendidura est√©tica
        g.lineTo(-20, 15);  // Base Abajo
        g.closePath();
        g.fillPath();
        
        // Detalle de cabina
        g.fillStyle(0xffffff, 0.5);
        g.fillCircle(5, 0, 5);

        g.generateTexture('ship', 60, 40);

        // LLAMA
        g.clear();
        g.fillStyle(0xfacc15);
        g.beginPath();
        g.moveTo(-12, 0);
        g.lineTo(-35, -8);
        g.lineTo(-30, 0);
        g.lineTo(-35, 8);
        g.closePath();
        g.fillPath();
        g.generateTexture('flame', 35, 20);

        // BOT√ìN Y PANEL
        g.clear(); g.fillStyle(0x1e293b); g.lineStyle(2, C.SHIP);
        g.fillRoundedRect(0,0,320,70,10); g.strokeRoundedRect(0,0,320,70,10);
        g.generateTexture('btn', 320, 70);

        g.clear(); g.fillStyle(0x020617, 0.95); g.lineStyle(2, C.SHIP);
        g.fillRoundedRect(0,0,650,450,15); g.strokeRoundedRect(0,0,650,450,15);
        g.generateTexture('panel', 650, 450);

        this.scene.start('MenuScene');
    }
}

// --- MEN√ö ---
class MenuScene extends Phaser.Scene {
    constructor() { super('MenuScene'); }
    create() {
        const w = this.scale.width; const h = this.scale.height;
        this.add.rectangle(0,0,w,h,C.BG).setOrigin(0);
        this.add.grid(w/2, h/2, w, h, 80, 80, C.GRID).setAlpha(0.2);

        this.add.text(w/2, h*0.25, "NEWTON'S LAB", { fontFamily: 'Orbitron', fontSize: '60px', color: '#fff' }).setOrigin(0.5);
        this.createBtn(w/2, h*0.55, "üöÄ SIMULADOR", C.VEL, () => this.scene.start('SimScene'));
        this.createBtn(w/2, h*0.72, "üß† EXAMEN", C.ACC, () => this.scene.start('QuizScene'));
    }
    createBtn(x, y, txt, color, cb) {
        let con = this.add.container(x, y);
        let img = this.add.image(0,0,'btn').setTint(color);
        let t = this.add.text(0,0,txt, { fontFamily:'Rajdhani', fontSize:'28px', color:'#fff' }).setOrigin(0.5);
        img.setInteractive({useHandCursor:true}).on('pointerdown', ()=>this.scene.start(this.scene.key === 'SimScene' ? 'MenuScene' : 'SimScene')); // Reset hack
        hit(img, con, cb);
        con.add([img, t]);
    }
}

function hit(obj, con, cb) {
    obj.on('pointerdown', () => {
        con.setScale(0.9);
        setTimeout(() => { con.setScale(1); cb(); }, 100);
    });
}

// --- SIMULADOR (EL N√öCLEO ARREGLADO) ---
class SimScene extends Phaser.Scene {
    constructor() { super('SimScene'); }
    create() {
        this.w = this.scale.width; this.h = this.scale.height;
        this.add.rectangle(0,0,this.w,this.h,C.BG).setOrigin(0);
        this.add.grid(this.w/2,this.h/2,this.w,this.h,60,60,C.GRID).setAlpha(0.3);

        // Telemetr√≠a
        this.txtStats = this.add.text(this.w-20, 20, "", { fontFamily:'monospace', fontSize:'18px', color:'#22d3ee', align:'right' }).setOrigin(1,0);
        this.add.text(20, 20, "üè† MEN√ö", { fontFamily:'Orbitron', fontSize:'16px' }).setInteractive().on('pointerdown', () => this.scene.start('MenuScene'));

        // Meta
        this.target = this.add.circle(this.w*0.8, this.h/2, 80).setStrokeStyle(2, C.VEL);
        this.physics.add.existing(this.target, true);
        this.targetTxt = this.add.text(this.target.x, this.target.y, "ZONA DE EQUILIBRIO", { fontFamily:'Orbitron', fontSize:'12px', color:'#4ade80' }).setOrigin(0.5);

        // COHETE (Sprite F√≠sico)
        this.ship = this.physics.add.image(100, this.h/2, 'ship');
        this.ship.setDrag(0); 
        this.ship.setCollideWorldBounds(true);
        this.ship.setBounce(0.3);

        // Llama (Hija del cohete)
        this.flame = this.add.image(0, 0, 'flame').setVisible(false);

        // CAPA DE VECTORES (Dibuja todo alineado)
        this.vGfx = this.add.graphics().setDepth(10);

        this.input.on('pointerdown', () => this.thrust = true);
        this.input.on('pointerup', () => this.thrust = false);
        this.thrust = false;
    }

    update() {
        const body = this.ship.body;
        this.vGfx.clear();

        // 1. Manejo de Rotaci√≥n y Empuje
        if(this.thrust) {
            let ptr = this.input.activePointer;
            if(ptr.y > 60) {
                let angle = Phaser.Math.Angle.Between(this.ship.x, this.ship.y, ptr.x, ptr.y);
                this.ship.setRotation(angle); // Apunta directo al rat√≥n
                
                // Fuerza Alineada
                this.physics.velocityFromRotation(angle, 60, body.acceleration);
                
                // Llama Alineada
                this.flame.setVisible(true);
                this.flame.setPosition(this.ship.x, this.ship.y);
                this.flame.setRotation(angle);
            }
        } else {
            body.setAcceleration(0);
            this.flame.setVisible(false);
        }

        // 2. Fricci√≥n en Meta
        let drag = 0;
        if(Phaser.Geom.Intersects.RectangleToRectangle(this.ship.getBounds(), this.target.getBounds())) {
            drag = 3.0;
            if(body.velocity.length() < 12) this.win();
        }
        this.ship.setDrag(drag);

        // 3. DIBUJAR VECTORES (Mec√°nica de precisi√≥n)
        this.renderVector(body.velocity, C.VEL, 0.6, "v");
        this.renderVector(body.acceleration, C.FORCE, 2.0, "F");

        // Telemetr√≠a Real
        let v = (body.velocity.length() * 0.1).toFixed(1);
        let f = (body.acceleration.length() * 10).toFixed(0);
        this.txtStats.setText(`VELOCIDAD: ${v} m/s\nFUERZA: ${f} N`);
    }

    renderVector(vec, color, scale, label) {
        if(vec.length() < 2) return;
        
        const angle = Math.atan2(vec.y, vec.x);
        const startX = this.ship.x;
        const startY = this.ship.y;
        const endX = startX + vec.x * scale;
        const endY = startY + vec.y * scale;

        this.vGfx.lineStyle(3, color, 0.8);
        this.vGfx.beginPath();
        this.vGfx.moveTo(startX, startY);
        this.vGfx.lineTo(endX, endY);
        this.vGfx.strokePath();

        // Cabeza de flecha
        this.vGfx.fillStyle(color, 1);
        this.vGfx.fillTriangle(
            endX, endY,
            endX - 10 * Math.cos(angle - 0.5), endY - 10 * Math.sin(angle - 0.5),
            endX - 10 * Math.cos(angle + 0.5), endY - 10 * Math.sin(angle + 0.5)
        );
    }

    win() {
        this.ship.body.reset(100, this.h/2);
        let nx = Phaser.Math.Between(this.w*0.5, this.w*0.9);
        let ny = Phaser.Math.Between(100, this.h-100);
        this.target.setPosition(nx, ny);
        this.target.body.updateFromGameObject();
        this.targetTxt.setPosition(nx, ny);
    }
}

// --- QUIZ (DID√ÅCTICO) ---
class QuizScene extends Phaser.Scene {
    constructor() { super('QuizScene'); }
    create() {
        this.w = this.scale.width; this.h = this.scale.height;
        this.qIdx = 0; this.score = 0;
        this.qs = QUESTIONS.sort(()=>0.5-Math.random()).slice(0,5);
        this.add.rectangle(0,0,this.w,this.h,0x020617).setOrigin(0);
        this.qText = this.add.text(this.w/2, 120, "", { fontFamily:'Rajdhani', fontSize:'26px', align:'center', wordWrap:{width:this.w*0.8} }).setOrigin(0.5,0);
        this.btns = [];
        for(let i=0; i<3; i++) {
            let b = this.add.image(this.w/2, 300+i*90, 'btn').setInteractive();
            let t = this.add.text(this.w/2, 300+i*90, "", { fontFamily:'Rajdhani', fontSize:'20px' }).setOrigin(0.5);
            b.on('pointerdown', () => this.check(i));
            this.btns.push({b, t});
        }
        this.loadQ();
    }
    loadQ() {
        if(this.qIdx >= this.qs.length) { this.scene.start('MenuScene'); return; }
        let d = this.qs[this.qIdx];
        this.qText.setText(d.q);
        this.btns.forEach((btn, i) => btn.t.setText(d.options[i]));
    }
    check(i) {
        let d = this.qs[this.qIdx];
        let ok = (i === d.ok);
        if(ok) this.score++;
        
        let p = this.add.image(this.w/2, this.h/2, 'panel').setDepth(20);
        let t = this.add.text(this.w/2, this.h/2 - 140, ok?"‚úì CORRECTO":"‚úó ERROR", { fontSize:'40px', color:ok?'#4ade80':'#f43f5e' }).setOrigin(0.5).setDepth(21);
        let dsc = this.add.text(this.w/2, this.h/2, `${d.expl}\n\n${d.tip}`, { fontFamily:'Rajdhani', fontSize:'20px', align:'center', wordWrap:{width:550} }).setOrigin(0.5).setDepth(21);
        let b = this.add.text(this.w/2, this.h/2 + 160, "CONTINUAR", { backgroundColor:'#3b82f6', padding:{x:20,y:10} }).setOrigin(0.5).setInteractive().setDepth(21)
            .on('pointerdown', () => { p.destroy(); t.destroy(); dsc.destroy(); b.destroy(); this.qIdx++; this.loadQ(); });
    }
}

const config = {
    type: Phaser.AUTO,
    scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH, width: 1280, height: 720 },
    parent: 'game-div',
    physics: { default: 'arcade', arcade: { gravity: { y: 0 } } },
    scene: [BootScene, MenuScene, SimScene, QuizScene]
};
new Phaser.Game(config);

</script>
</body>
</html>