<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Algebra Master 4º ESO - Universal Responsive Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.60.0/phaser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=JetBrains+Mono:wght@400;700&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --blue: #38bdf8; --purple: #a78bfa; --emerald: #10b981; --red: #fb7185; --bg: #020617; --slate: #0f172a;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        
        html, body { 
            width: 100%; height: 100%; 
            background: var(--bg); color: white; font-family: 'Space Grotesk', sans-serif; 
            overflow: hidden; position: fixed;
        }

        #game-container { 
            width: 100%; height: 100%; 
            position: relative; overflow: hidden; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* Botón Home Universal */
        #universal-home {
            position: absolute; top: env(safe-area-inset-top, 10px); right: env(safe-area-inset-right, 10px); 
            width: 40px; height: 40px;
            background: rgba(30, 41, 59, 0.8); border: 2px solid var(--blue); border-radius: 10px;
            display: flex; align-items: center; justify-content: center; color: var(--blue);
            cursor: pointer; z-index: 2500; transition: 0.3s; backdrop-filter: blur(10px);
        }

        /* Overlay Screens */
        .overlay-screen {
            position: absolute; inset: 0; background: radial-gradient(circle at center, #0f172a 0%, #020617 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000; padding: 15px; text-align: center;
        }
        
        .card {
            background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(56, 189, 248, 0.3); 
            padding: 25px; border-radius: 25px; backdrop-filter: blur(20px); 
            width: 95%; max-width: 600px; max-height: 85vh; overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }
        
        .mode-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 20px; }
        @media (min-width: 600px) { .mode-grid { grid-template-columns: 1fr 1fr; } }

        .mode-btn {
            background: #1e293b; border: 2px solid var(--blue); color: white;
            padding: 15px; border-radius: 15px; cursor: pointer; transition: 0.3s;
            display: flex; flex-direction: column; align-items: center; gap: 8px;
        }
        .mode-btn i { font-size: 2em; }
        .mode-btn h2 { margin: 0; font-family: 'Orbitron'; font-size: 0.85rem; }

        /* HUD */
        .hud { 
            position: absolute; top: env(safe-area-inset-top, 10px); left: env(safe-area-inset-left, 10px); 
            display: none; gap: 8px; z-index: 500; pointer-events: none; 
        }
        .stat { background: rgba(15, 23, 42, 0.9); padding: 6px 12px; border-radius: 8px; border: 1px solid var(--blue); font-weight: bold; font-family: 'Orbitron'; font-size: 0.7rem; }

        /* Game Elements */
        #polynomial-area {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            display: none; flex-direction: column; align-items: center; width: 90%; z-index: 100;
        }
        .poly-display { font-size: 1.8rem; font-family: 'JetBrains Mono'; color: var(--blue); text-shadow: 0 0 20px rgba(56, 189, 248, 0.5); font-weight: 700; margin-bottom: 10px; text-align: center; }
        @media (min-width: 800px) { .poly-display { font-size: 3rem; } }
        
        .feedback-msg { font-size: 1rem; min-height: 2.5em; text-align: center; max-width: 500px; color: #94a3b8; padding: 0 10px; }

        /* Controles */
        .controls { 
            position: absolute; bottom: env(safe-area-inset-bottom, 20px); left: 50%; transform: translateX(-50%); 
            display: none; gap: 10px; width: 95%; max-width: 700px; z-index: 500;
        }
        .tool {
            flex: 1; background: rgba(30, 41, 59, 0.95); border: 2px solid var(--blue); color: var(--blue);
            padding: 12px 5px; border-radius: 12px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; gap: 5px; font-family: 'Orbitron'; font-weight: 900; font-size: 0.65rem;
        }

        /* Quiz View */
        #quiz-view { display: none; z-index: 1000; overflow-y: auto; padding: 20px 0; }
        .quiz-card { 
            background: rgba(15, 23, 42, 0.95); border: 2px solid var(--purple); padding: 20px; 
            border-radius: 20px; width: 95%; max-width: 700px; margin: auto;
        }
        .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(167, 139, 250, 0.2); }
        .q-text { font-size: 1.1rem; font-weight: 700; margin-bottom: 15px; line-height: 1.3; }
        .expl-box { margin-top: 10px; padding: 12px; border-radius: 12px; display: none; text-align: left; border-left: 5px solid; font-size: 0.8rem; }

        /* Modales */
        .modal { position: fixed; inset: 0; background: rgba(2, 6, 23, 0.9); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(10px); }
        .modal-body { background: #1e293b; border: 2px solid var(--blue); padding: 20px; border-radius: 25px; max-width: 500px; width: 95%; text-align: center; }
        .opt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .opt-btn { background: #0f172a; border: 1px solid #334155; color: white; padding: 12px 5px; border-radius: 10px; cursor: pointer; font-family: 'JetBrains Mono'; font-size: 0.8rem; }

        .btn-main { background: var(--emerald); color: var(--bg); border: none; padding: 10px 25px; border-radius: 10px; font-weight: 900; cursor: pointer; font-family: 'Orbitron'; font-size: 0.8rem; }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="universal-home" onclick="location.reload()" title="Volver al Inicio">
            <i class="fas fa-home"></i>
        </div>

        <!-- Pantalla Inicio -->
        <div id="start-screen" class="overlay-screen">
            <div class="card">
                <h1 class="orbitron text-xl md:text-3xl font-black mb-1">ALGEBRA <span style="color:var(--blue)">MASTER</span></h1>
                <p class="text-slate-400 font-bold tracking-widest text-[9px] mb-4 uppercase">Responsive Suite v6.0</p>
                <div class="mode-grid">
                    <button class="mode-btn" onclick="initMode('lab')">
                        <i class="fas fa-flask-vial text-emerald-400"></i>
                        <h2>LABORATORIO</h2>
                    </button>
                    <button class="mode-btn" onclick="initMode('quiz')" style="border-color: var(--purple);">
                        <i class="fas fa-brain text-purple-400"></i>
                        <h2>QUIZ TEÓRICO</h2>
                    </button>
                </div>
            </div>
        </div>

        <!-- Instrucciones -->
        <div id="instruction-overlay" class="overlay-screen" style="display: none;">
            <div class="card">
                <h2 id="ins-title" class="font-orbitron text-lg mb-3 text-blue-400"></h2>
                <div id="ins-body" class="text-left text-slate-300 leading-relaxed mb-5 space-y-2 text-xs"></div>
                <button class="btn-main w-full" id="btn-begin">INICIAR</button>
            </div>
        </div>

        <!-- Lab HUD -->
        <div id="lab-hud" class="hud">
            <div class="stat"><i class="fas fa-heart text-red-500 mr-1"></i> <span id="stability-text">100</span>%</div>
            <div class="stat"><i class="fas fa-layer-group text-blue-400 mr-1"></i> <span id="level-text">1</span>/5</div>
        </div>

        <!-- Lab Area -->
        <div id="polynomial-area">
            <div id="poly-val" class="poly-display"></div>
            <div id="poly-hint" class="feedback-msg"></div>
        </div>

        <!-- Lab Controles -->
        <div id="lab-controls" class="controls">
            <button class="tool" onclick="selectTool('common')"><i class="fas fa-compress-alt"></i><span>COMÚN</span></button>
            <button class="tool" onclick="selectTool('identity')"><i class="fas fa-dna"></i><span>NOTABLE</span></button>
            <button class="tool" onclick="selectTool('ruffini')"><i class="fas fa-table-list"></i><span>RUFFINI</span></button>
        </div>

        <!-- Quiz Area -->
        <div id="quiz-view" class="overlay-screen">
            <div class="quiz-card">
                <div class="quiz-header">
                    <span class="stat" style="border-color:var(--purple); color:var(--purple)">Q: <span id="q-count">1</span></span>
                    <span class="stat">SCORE: <span id="quiz-score-val">0</span></span>
                </div>
                <div id="q-question" class="q-text"></div>
                <div id="q-options" class="opt-grid"></div>
                <div id="q-expl" class="expl-box"></div>
                <button id="btn-next" class="btn-main mt-3" style="display:none">CONTINUAR <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>

        <!-- Modales -->
        <div id="tool-modal" class="modal">
            <div class="modal-body">
                <h3 id="tool-title" class="font-orbitron text-sm mb-2">SELECCIONAR FACTOR</h3>
                <div id="opt-container" class="opt-grid"></div>
                <button class="opt-btn w-full mt-2 border-red-500 text-red-400" onclick="closeToolModal()">CANCELAR</button>
            </div>
        </div>

        <div id="end-modal" class="modal">
            <div class="modal-body">
                <i id="end-icon" class="fas fa-trophy fa-3x mb-3 text-yellow-400"></i>
                <h2 id="end-title" class="font-orbitron text-xl mb-2">MISIÓN COMPLETADA</h2>
                <p id="end-message" class="text-slate-400 mb-4 text-xs"></p>
                <button class="btn-main w-full" onclick="location.reload()">REINICIAR</button>
            </div>
        </div>
    </div>

    <script>
        const LAB_DATA = [
            { 
                start: "x² - 64", 
                steps: [{ type: 'identity', choice: "(x+8)(x-8)", next: "(x+8)(x-8)" }],
                hints: { 
                    common: "No hay letras ni números comunes.", 
                    ruffini: "Prueba con identidades notables primero.", 
                    identity: "¡Correcto! Diferencia de cuadrados: x² - 8².",
                    wrong_choice: "Busca la raíz de 64."
                }
            },
            { 
                start: "x³ - 4x", 
                steps: [
                    { type: 'common', choice: "x", next: "x(x² - 4)" },
                    { type: 'identity', choice: "(x+2)(x-2)", next: "x(x+2)(x-2)" }
                ],
                hints: { 
                    common: "¡Bien! Extrae la x que se repite.", 
                    identity: "Diferencia de cuadrados: (x² - 2²).", 
                    ruffini: "Simplifica con factor común primero.",
                    wrong_choice_common: "Saca la x de menor grado.",
                    wrong_choice_identity: "4 es 2²."
                }
            },
            { 
                start: "x² + 14x + 49", 
                steps: [{ type: 'identity', choice: "(x+7)²", next: "(x+7)²" }],
                hints: { 
                    identity: "¡Brillante! Cuadrado de una suma: (x+7)².", 
                    common: "Sin factores comunes.",
                    wrong_choice: "7² es 49 y 2*7 es 14."
                }
            },
            { 
                start: "x² - 8x + 15", 
                steps: [{ type: 'ruffini', choice: "Raíz: 3", next: "(x-3)(x-5)" }],
                hints: { 
                    ruffini: "Divisores de 15: 1, 3, 5... Probamos el 3.", 
                    identity: "No es identidad perfecta.",
                    wrong_choice: "Esa raíz no anula el polinomio."
                }
            },
            { 
                start: "3x³ - 27x", 
                steps: [
                    { type: 'common', choice: "3x", next: "3x(x² - 9)" },
                    { type: 'identity', choice: "(x+3)(x-3)", next: "3x(x+3)(x-3)" }
                ],
                hints: { 
                    common: "Extraemos el 3 y la x.", 
                    identity: "Diferencia de cuadrados en el paréntesis.",
                    wrong_choice_common: "Divide por 3 y por x.",
                    wrong_choice_identity: "9 es 3²."
                }
            }
        ];

        const QUIZ_DATA = [
            {
                q: "¿Cuál es el factor de la raíz x = -2?",
                o: ["(x - 2)", "(x + 2)", "x", "2x"],
                c: 1,
                e: "¡Correcto! Factor = (x - raíz).",
                w: "Incorrecto. Se cambia el signo."
            },
            {
                q: "¿Qué simplificamos en fracciones?",
                o: ["Sumas", "Factores", "Restas", "Todo"],
                c: 1,
                e: "¡Exacto! Solo productos.",
                w: "Fallo. Jamás simplifiques sumas."
            }
        ];

        let mode = '', level = 0, stability = 100, score = 0, step = 0;

        function initMode(m) {
            mode = m;
            document.getElementById('start-screen').style.display = 'none';
            showInstructions();
        }

        function showInstructions() {
            const overlay = document.getElementById('instruction-overlay');
            document.getElementById('ins-title').innerText = mode === 'lab' ? "LABORATORIO" : "TEST TEÓRICO";
            document.getElementById('ins-body').innerHTML = mode === 'lab' ? 
                "<p>Factoriza usando las herramientas en orden.</p>" : 
                "<p>Responde correctamente para ganar puntos.</p>";
            overlay.style.display = 'flex';
            document.getElementById('btn-begin').onclick = startActualGame;
        }

        function startActualGame() {
            document.getElementById('instruction-overlay').style.display = 'none';
            if (mode === 'lab') {
                document.getElementById('lab-hud').style.display = 'flex';
                document.getElementById('polynomial-area').style.display = 'flex';
                document.getElementById('lab-controls').style.display = 'flex';
                loadLabLevel();
            } else {
                document.getElementById('quiz-view').style.display = 'flex';
                loadQuizQuestion();
            }
        }

        function loadLabLevel() {
            const data = LAB_DATA[level];
            document.getElementById('poly-val').innerText = data.start;
            document.getElementById('poly-hint').innerText = "Iniciando análisis...";
            document.getElementById('poly-hint').style.color = "#94a3b8";
            document.getElementById('level-text').innerText = level + 1;
            step = 0;
        }

        function selectTool(t) {
            const modal = document.getElementById('tool-modal');
            const container = document.getElementById('opt-container');
            modal.style.display = 'flex';
            container.innerHTML = "";
            let opts = (t === 'common') ? ["x", "3x", "2", "3"] : 
                       (t === 'identity') ? ["(x+8)(x-8)", "(x+7)²", "(x+3)(x-3)", "(x+2)(x-2)"] : 
                       ["Raíz: 1", "Raíz: 2", "Raíz: 3", "Raíz: -1"];
            opts.sort(() => Math.random() - 0.5).forEach(o => {
                const btn = document.createElement('button');
                btn.className = "opt-btn"; btn.innerText = o;
                btn.onclick = () => processChoice(t, o);
                container.appendChild(btn);
            });
        }

        function processChoice(t, o) {
            const data = LAB_DATA[level];
            const currentStep = data.steps[step];
            closeToolModal();
            if (currentStep.type === t && currentStep.choice === o) {
                step++;
                document.getElementById('poly-val').innerText = currentStep.next;
                document.getElementById('poly-hint').innerText = data.hints[t];
                document.getElementById('poly-hint').style.color = "var(--emerald)";
                if (step >= data.steps.length) {
                    setTimeout(() => {
                        level++;
                        if (level >= LAB_DATA.length) finishGame(true, "MAESTRÍA LOGRADA.");
                        else loadLabLevel();
                    }, 1000);
                }
            } else {
                stability -= 20;
                document.getElementById('stability-text').innerText = stability;
                document.getElementById('poly-hint').innerText = data.hints[t] || "Error detectado.";
                document.getElementById('poly-hint').style.color = "var(--red)";
                if (stability <= 0) finishGame(false, "COLAPSO DEL SISTEMA.");
            }
        }

        function loadQuizQuestion() {
            const q = QUIZ_DATA[level];
            document.getElementById('q-count').innerText = level + 1;
            document.getElementById('quiz-score-val').innerText = score;
            document.getElementById('q-question').innerText = q.q;
            document.getElementById('q-expl').style.display = 'none';
            document.getElementById('btn-next').style.display = 'none';
            const opts = document.getElementById('q-options');
            opts.innerHTML = "";
            q.o.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "opt-btn"; btn.innerText = opt;
                btn.onclick = () => answerQuiz(idx);
                opts.appendChild(btn);
            });
        }

        function answerQuiz(idx) {
            const q = QUIZ_DATA[level];
            const btns = document.querySelectorAll('#q-options .opt-btn');
            btns.forEach(b => b.disabled = true);
            const expl = document.getElementById('q-expl');
            expl.style.display = 'block';
            document.getElementById('btn-next').style.display = 'inline-block';
            if (idx === q.c) {
                score += 100; expl.innerHTML = q.e; expl.style.color = "var(--emerald)";
            } else {
                expl.innerHTML = q.w; expl.style.color = "var(--red)";
            }
            document.getElementById('btn-next').onclick = () => {
                level++;
                if (level >= QUIZ_DATA.length) finishGame(true, `Test finalizado. Score: ${score}`);
                else loadQuizQuestion();
            };
        }

        function closeToolModal() { document.getElementById('tool-modal').style.display = 'none'; }

        function finishGame(win, msg) {
            document.getElementById('end-modal').style.display = 'flex';
            document.getElementById('end-message').innerText = msg;
        }

        // Phaser
        new Phaser.Game({
            type: Phaser.AUTO, parent: 'game-container', width: window.innerWidth, height: window.innerHeight, transparent: true,
            scene: {
                create() {
                    this.add.particles(0, 0, 'dot', {
                        x: { min: 0, max: window.innerWidth }, y: { min: 0, max: window.innerHeight },
                        speed: 5, scale: { start: 0.1, end: 0 }, alpha: 0.2, lifespan: 8000, frequency: 300, blendMode: 'ADD'
                    });
                }
            }
        });
    </script>
</body>
</html>
