<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Mestre de Fraccions 5.0 - Versi√≥ Final</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            background: #1a1a2e; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100dvh; 
            overflow: hidden; 
            font-family: -apple-system, system-ui, sans-serif;
        }
        #game-container { 
            width: 100%; 
            height: 100%; 
            max-width: 800px;
            max-height: 600px;
        }
    </style>
</head>
<body>
    <div id="game-container"></div>
    <script>
        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: "game-container",
            backgroundColor: "#f0f0f0",
            scale: {
                mode: Phaser.Scale.FIT,
                autoCenter: Phaser.Scale.CENTER_BOTH
            },
            physics: { default: "arcade", arcade: { gravity: { y: 0 } } },
            scene: { preload: preload, create: create, update: update }
        };

        const game = new Phaser.Game(config);
        let score = 0;
        let questionIndex = 0;
        let pool = [];
        const totalQuestions = 10;

        const allQuestions = [
            // Fonaments i Definicions
            { type: "text", q: "Qu√® indica el denominador d'una fracci√≥?", a: ["Les parts que agafem", "Parts en qu√® dividim la unitat", "El resultat final"], c: 1, f: "El denominador (baix) indica en quantes parts iguals dividim l'unitat.", tip: "Pensa en el denominador com el total de talls d'una pizza." },
            { type: "text", q: "Qu√® indica el numerador?", a: ["Les parts que prenem", "Les parts totals", "La suma"], c: 0, f: "El numerador (dalt) diu quants talls hem agafat realment.", tip: "Numerar √©s comptar les peces que tens a la m√†." },
            
            // Lectures (Fitxa 2)
            { type: "fraction", q: "Com es llegeix aquesta fracci√≥?", n: 1, d: 2, a: ["Un segon", "Una meitat", "Un mig"], c: 1, f: "1/2 √©s la meitat de la unitat.", tip: "Sempre que hi haja un 2 baix, √©s una meitat." },
            { type: "fraction", q: "Com es llegeix aquesta?", n: 1, d: 3, a: ["Un ter√ß", "Un tres", "Un tercer"], c: 0, f: "El n√∫mero 3 baix es llegeix com 'ter√ß'.", tip: "3 parts = ter√ßos." },
            { type: "fraction", q: "Com es llegeix aquesta?", n: 1, d: 4, a: ["Un quart", "Un quatre", "Un quatr√©"], c: 0, f: "1/4 √©s un quart de la unitat.", tip: "Com un quart d'hora." },
            { type: "fraction", q: "I aquesta fracci√≥?", n: 1, d: 6, a: ["Un sis√©", "Un sisena", "Un sis"], c: 0, f: "El 6 baix es llegeix com 'sis√©'.", tip: "6 parts = sisens." },
            { type: "fraction", q: "Com es diu aquesta?", n: 1, d: 8, a: ["Un huitena", "Un vuit√©", "Un vuit"], c: 1, f: "El 8 baix es llegeix com 'vuit√©'.", tip: "8 parts = vuitens." },
            { type: "fraction", q: "Lectura de la seg√ºent:", n: 3, d: 5, a: ["Tres cinc", "Tres cinquens", "Cinc ter√ßos"], c: 1, f: "3/5 s√≥n tres cinquens.", tip: "5 baix sempre √©s 'cinquens'." },
            { type: "fraction", q: "Lectura de la seg√ºent:", n: 7, d: 12, a: ["Set dotzens", "Dotze setens", "Set dotze"], c: 0, f: "A partir de 10 afegim '-ens'.", tip: "12 = dotzens." },
            { type: "fraction", q: "Com es llegeix 18/11?", n: 18, d: 11, a: ["Onze divuitens", "Divuit onzens", "Divuit d'onze"], c: 1, f: "18/11 s√≥n divuit onzens.", tip: "Recorda la terminaci√≥ '-ens'." },
            { type: "fraction", q: "Com es llegeix 15/15?", n: 15, d: 15, a: ["Quinze quinzens", "Unitat quinze", "Zero"], c: 0, f: "Es llegeix quinze quinzens (que √©s 1 unitat).", tip: "Numerador i denominador iguals!" },
            { type: "fraction", q: "Lectura de 1/20:", n: 1, d: 20, a: ["Un vint", "Un vint√©", "Un vintens"], c: 1, f: "1/20 s'anomena un vint√©.", tip: "20 baix = vint√©." },

            // Equivalents a la Unitat (Fitxa 4)
            { type: "fraction", q: "√âs equivalent a la unitat?", n: 8, d: 8, a: ["No", "Tal vegada", "S√≠"], c: 2, f: "Si dalt i baix s√≥n iguals, tens la unitat completa.", tip: "8 talls de 8 √©s la pizza sencera!" },
            { type: "fraction", q: "√âs 11/9 equivalent a 1 unitat?", n: 11, d: 9, a: ["S√≠", "No", "Nom√©s en festes"], c: 1, f: "No, 11/9 √©s major que la unitat.", tip: "Per ser 1 unitat han de ser IGUALS." },
            { type: "fraction", q: "√âs 31/31 equivalent a 1 unitat?", n: 31, d: 31, a: ["No", "M√©s o menys", "S√≠"], c: 2, f: "S√≠, qualsevol fracci√≥ amb n√∫meros iguals val 1.", tip: "31/31 = 1." },

            // Pr√≤pies i Impr√≤pies (Fitxa 5)
            { type: "fraction", q: "Aquesta fracci√≥ √©s PR√íPIA?", n: 1, d: 5, a: ["S√≠ (menor que 1)", "No", "√âs la unitat"], c: 0, f: "√âs pr√≤pia perqu√® 1 √©s menor que 5.", tip: "Pr√≤pia = Cap de dalt xicotet." },
            { type: "fraction", q: "√âs 6/5 una fracci√≥ pr√≤pia?", n: 6, d: 5, a: ["S√≠", "No (√©s impr√≤pia)", "√âs zero"], c: 1, f: "No, √©s impr√≤pia perqu√® 6 > 5.", tip: "Impr√≤pia = El de dalt √©s major." },
            { type: "fraction", q: "Qu√® √©s 12/9?", n: 12, d: 9, a: ["Pr√≤pia", "Impr√≤pia", "Unitat"], c: 1, f: "Impr√≤pia, el numerador guanya al denominador.", tip: "Impr√≤pia = M√©s d'una unitat." },
            { type: "fraction", q: "Qu√® √©s 91/100?", n: 91, d: 100, a: ["Pr√≤pia", "Impr√≤pia", "Unitat"], c: 0, f: "Pr√≤pia, perqu√® encara no arriba a 100.", tip: "Pr√≤pia = Encara no tenim la unitat." },

            // Equival√®ncies i Truc de la Creu (Fitxa 6)
            { type: "text", q: "S√≥n 2/3 i 4/6 equivalents?", a: ["No", "S√≠", "Dep√©n del dibuix"], c: 1, f: "S√≠, perqu√® 2x6=12 i 3x4=12.", tip: "Usa el TRUC DE LA CREU per a comprovar-ho." },
            { type: "text", q: "S√≥n 1/4 i 3/12 equivalents?", a: ["S√≠", "No", "S√≥n iguals a 1"], c: 0, f: "S√≠, 1x12 = 12 i 4x3 = 12.", tip: "Multiplica en creu!" },

            // Operacions (Fitxa 8, 9 i 10)
            { type: "op", q: "Calcula la suma:", n1: 2, d1: 6, op: "+", n2: 3, d2: 6, a: ["5/12", "5/6", "6/6"], c: 1, f: "2/6 + 3/6 = 5/6.", tip: "Suma nom√©s els de dalt." },
            { type: "op", q: "Suma la seg√ºent:", n1: 4, d1: 7, op: "+", n2: 2, d2: 7, a: ["6/14", "6/0", "6/7"], c: 2, f: "4/7 + 2/7 = 6/7.", tip: "El denominador es mant√©." },
            { type: "op", q: "Resta la seg√ºent:", n1: 4, d1: 5, op: "-", n2: 1, d2: 5, a: ["3/0", "3/5", "3/10"], c: 1, f: "4/5 - 1/5 = 3/5.", tip: "Resta els de dalt, deixa el de baix." },
            { type: "op", q: "Operaci√≥ combinada:", n1: 4, d1: 10, op: "+", n2: 1, d2: 10, op2: "-", n3: 3, d3: 10, a: ["2/10", "8/10", "5/10"], c: 0, f: "(4+1) - 3 = 2. Resultat 2/10.", tip: "Fes primer el par√®ntesi!" },
            { type: "op", q: "Calcula:", n1: 5, d1: 11, op: "-", n2: 2, d2: 11, op2: "+", n3: 1, d3: 11, a: ["4/11", "2/11", "6/11"], c: 1, f: "5 - (2+1) = 5 - 3 = 2. Resultat 2/11.", tip: "Compte amb el par√®ntesi!" },

            // Problemes (Fitxa 11 i Fitxa 7)
            { type: "text", q: "Elena t√© 30 alumnes. 3/5 fan nataci√≥. Quants en fan?", a: ["15", "18", "20"], c: 1, f: "30 / 5 = 6. I 6 * 3 = 18.", tip: "Divideix pel de baix i multiplica pel de dalt." },
            { type: "text", q: "Na Paula t√© 72 flors. 5/8 s√≥n roses. Quantes en t√©?", a: ["40", "45", "50"], c: 1, f: "72 / 8 = 9. 9 * 5 = 45.", tip: "Troba quant √©s 1/8 primer." },
            { type: "text", q: "El pare et d√≥na 1/8 de past√≠s i al germ√† 2/16. Qui en menja m√©s?", a: ["Tu", "Ell", "Igual"], c: 2, f: "S√≥n equivalents (1/8 = 2/16).", tip: "Mengeu el mateix!" },
            { type: "text", q: "Pau menja 4/10 de pizza i Lorena 3/10. Quina fracci√≥ mengen total?", a: ["7/20", "7/10", "1/10"], c: 1, f: "4/10 + 3/10 = 7/10.", tip: "Suma els trossos que han agafat." },
            { type: "text", q: "Quina fracci√≥ de pizza menja Lorena MENYS que Pau (4/10 vs 3/10)?", a: ["1/10", "2/10", "7/10"], c: 0, f: "4/10 - 3/10 = 1/10.", tip: "Resta el que ha menjat cadasc√∫." }
        ];

        function preload() {}
        function create() { this.showMainMenu(); }
        function update() {}

        Phaser.Scene.prototype.showMainMenu = function() {
            this.children.removeAll();
            this.cameras.main.setBackgroundColor('#ffde59'); // Groc vibrant Neo-Brutal

            this.add.text(400, 150, 'üí©', { fontSize: '150px' }).setOrigin(0.5);
            this.add.text(400, 300, "MESTRE DE\nFRACCIONS", { 
                fontSize: "60px", fill: "#000", fontWeight: "900", align: 'center', stroke: "#000", strokeThickness: 2
            }).setOrigin(0.5);

            this.drawBrutalButton(400, 440, "QUIZ DE MESTRIA", 0x5ce1e6).on("pointerdown", () => this.startQuiz());
            this.drawBrutalButton(400, 530, "CA√áA DE CAQUES", 0xff5757).on("pointerdown", () => this.showInstructions());
        };

        Phaser.Scene.prototype.drawBrutalButton = function(x, y, text, color, width = 600) {
            let shadow = this.add.graphics().fillStyle(0x000000, 1).fillRoundedRect(x - width/2 + 8, y - 35 + 8, width, 70, 20);
            let g = this.add.graphics().fillStyle(color, 1).fillRoundedRect(x - width/2, y - 35, width, 70, 20).lineStyle(5, 0x000, 1).strokeRoundedRect(x - width/2, y - 35, width, 70, 20);
            this.add.text(x, y, text, { fontSize: "28px", fill: "#000", fontWeight: "900" }).setOrigin(0.5);
            return this.add.rectangle(x, y, width, 70, 0, 0).setInteractive({ useHandCursor: true });
        };

        Phaser.Scene.prototype.drawHomeButton = function() {
            let btnX = 45;
            let btnY = 40;
            let size = 50;
            // Shadow y Bot√≥n m√°s peque√±os
            let shadow = this.add.graphics().fillStyle(0x000000, 1).fillRoundedRect(btnX - size/2 + 4, btnY - size/2 + 4, size, size, 12);
            let g = this.add.graphics().fillStyle(0xffffff, 1).fillRoundedRect(btnX - size/2, btnY - size/2, size, size, 12).lineStyle(3, 0x000, 1).strokeRoundedRect(btnX - size/2, btnY - size/2, size, size, 12);
            let icon = this.add.text(btnX, btnY, 'üè†', { fontSize: '28px' }).setOrigin(0.5);
            let area = this.add.rectangle(btnX, btnY, size, size, 0, 0).setInteractive({ useHandCursor: true });
            
            // Asegurar que est√© por encima de todo (depth alto)
            shadow.setDepth(100);
            g.setDepth(100);
            icon.setDepth(100);
            area.setDepth(101);

            area.on('pointerdown', () => {
                this.time.removeAllEvents();
                this.showMainMenu();
            });
        };

        Phaser.Scene.prototype.showInstructions = function() {
            this.children.removeAll();
            this.cameras.main.setBackgroundColor('#000');
            this.drawHomeButton();
            this.add.text(400, 200, "OBJECTIU", { fontSize: "50px", fill: "#ffde59", fontWeight: "900" }).setOrigin(0.5);
            this.add.text(400, 320, "Clica les FRACCIONS PR√íPIES\n(N√∫mero de DALT m√©s XICOTET)", { fontSize: "26px", fill: "#fff", align: 'center' }).setOrigin(0.5);
            this.drawBrutalButton(400, 480, "¬°JUGAR ARA!", 0x5ce1e6).on("pointerdown", () => this.startGame());
        };

        Phaser.Scene.prototype.startQuiz = function() {
            score = 0; questionIndex = 0;
            pool = [...allQuestions].sort(() => Math.random() - 0.5).slice(0, 10);
            this.nextQuiz();
        };

        Phaser.Scene.prototype.nextQuiz = function() {
            this.children.removeAll();
            if (questionIndex >= pool.length) return this.showFinalResults();
            let q = pool[questionIndex];

            this.cameras.main.setBackgroundColor('#a29bfe');
            this.drawHomeButton();
            this.add.graphics().fillStyle(0x000, 1).fillRoundedRect(48, 48, 720, 520, 30); // Shadow
            this.add.graphics().fillStyle(0xffffff, 1).fillRoundedRect(40, 40, 720, 520, 30).lineStyle(5, 0x000, 1).strokeRoundedRect(40, 40, 720, 520, 30);

            this.add.text(400, 100, q.q, { fontSize: "28px", fill: "#000", fontWeight: "900", align: "center", wordWrap: { width: 650 } }).setOrigin(0.5);

            if (q.type === "fraction") this.drawFraction(400, 210, q.n, q.d);
            else if (q.type === "op") this.drawOp(400, 210, q);

            q.a.forEach((opt, i) => {
                let btn = this.drawBrutalButton(400, 370 + (i * 75), opt, 0x5ce1e6, 680);
                btn.on("pointerdown", () => this.handleAnswer(i, q));
            });
        };

        Phaser.Scene.prototype.handleAnswer = function(idx, q) {
            let isCorrect = (idx === q.c);
            if (isCorrect) score++;
            this.children.removeAll();
            this.cameras.main.setBackgroundColor(isCorrect ? '#7ed957' : '#ff5757');
            this.add.text(400, 100, isCorrect ? "CORRECTE! üéâ" : "OH NO! üí©", { fontSize: "60px", fill: "#000", fontWeight: "900" }).setOrigin(0.5);
            
            this.add.graphics().fillStyle(0x000, 1).fillRoundedRect(108, 188, 600, 280, 30);
            this.add.graphics().fillStyle(0xffffff, 1).fillRoundedRect(100, 180, 600, 280, 30).lineStyle(5, 0x000, 1).strokeRoundedRect(100, 180, 600, 280, 30);
            
            this.add.text(400, 260, q.f, { fontSize: "24px", fill: "#000", align: "center", wordWrap: { width: 550 }, fontWeight: "bold" }).setOrigin(0.5);
            this.add.text(400, 380, `üí° Consell: ${q.tip}`, { fontSize: "20px", fill: "#000", fontStyle: "italic" }).setOrigin(0.5);

            this.drawBrutalButton(400, 530, "SEG√úENT", 0xffde59).on("pointerdown", () => { questionIndex++; this.nextQuiz(); });
        };

        Phaser.Scene.prototype.startGame = function() {
            score = 0; this.children.removeAll();
            this.cameras.main.setBackgroundColor('#7ed957');
            this.drawHomeButton();
            let time = 30;
            let timerTxt = this.add.text(400, 40, `TEMPS: ${time}s`, { fontSize: "32px", fill: "#000", fontWeight: "900" }).setOrigin(0.5);
            let scoreTxt = this.add.text(120, 40, `PUNTS: 0`, { fontSize: "26px", fill: "#000", fontWeight: "900" }).setOrigin(0.5);

            this.time.addEvent({ delay: 1200, callback: () => this.spawnFallingCard(scoreTxt), loop: true });
            this.time.addEvent({ delay: 1000, callback: () => { time--; timerTxt.setText(`TEMPS: ${time}s`); if (time <= 0) this.showFinalResults(); }, loop: true });
        };

                Phaser.Scene.prototype.spawnFallingCard = function(st) {
                    let x = Phaser.Math.Between(150, 650);
                    let n = Phaser.Math.Between(1, 15); let d = Phaser.Math.Between(4, 12); let isProper = n < d;
        
                    let card = this.add.rectangle(x, -100, 130, 160, 0xffffff).setInteractive().setStrokeStyle(5, 0x000);
                    let poop = this.add.text(x, -150, 'üí©', { fontSize: '40px' }).setOrigin(0.5);
                    let num = this.add.text(x, -100, n, { fontSize: '38px', fill: '#ff5757', fontWeight: '900' }).setOrigin(0.5);
                    let line = this.add.rectangle(x, -75, 60, 5, 0x000).setOrigin(0.5);
                    let den = this.add.text(x, -50, d, { fontSize: '38px', fill: '#5ce1e6', fontWeight: '900' }).setOrigin(0.5);
        
                    this.physics.add.existing(card);
                    card.body.setVelocityY(200);
        
                                let sync = () => {
                                    if (!card.active) return;
                                    // Posici√≥ fixa sobre la targeta (sense ball)
                                    poop.x = card.x;
                                    poop.y = card.y - 75;
                                    
                                    num.x = card.x; num.y = card.y - 25; 
                                    line.x = card.x; line.y = card.y + 5; 
                                    den.x = card.x; den.y = card.y + 35;
                                };                    this.events.on('update', sync);
        
                    card.on('pointerdown', () => {
                        if (isProper) { score += 10; card.setFillStyle(0x7ed957); }
                        else { score -= 5; card.setFillStyle(0xff5757); this.cameras.main.shake(100, 0.01); }
                        st.setText(`PUNTS: ${score}`);
                        this.events.off('update', sync); card.destroy(); poop.destroy(); num.destroy(); line.destroy(); den.destroy();
                    });
                };
        Phaser.Scene.prototype.showFinalResults = function() {
            this.children.removeAll(); this.cameras.main.setBackgroundColor('#ffde59');
            this.add.text(400, 200, "FINAL!", { fontSize: "60px", fill: "#000", fontWeight: "900" }).setOrigin(0.5);
            this.add.text(400, 320, `Puntuaci√≥: ${score}`, { fontSize: "40px", fill: "#000", fontWeight: "900" }).setOrigin(0.5);
            this.drawBrutalButton(400, 480, "TORNAR AL MEN√ö", 0x5ce1e6).on("pointerdown", () => this.showMainMenu());
        };

        Phaser.Scene.prototype.drawFraction = function(x, y, n, d) {
            this.add.text(x, y - 45, n, { fontSize: "56px", fill: "#ff5757", fontWeight: "900" }).setOrigin(0.5);
            this.add.rectangle(x, y, 90, 6, 0x000).setOrigin(0.5);
            this.add.text(x, y + 50, d, { fontSize: "56px", fill: "#5ce1e6", fontWeight: "900" }).setOrigin(0.5);
        };

        Phaser.Scene.prototype.drawOp = function(x, y, q) {
            this.drawFraction(x-85, y, q.n1, q.d1);
            this.add.text(x, y, q.op, { fontSize: "48px", fill: "#000", fontWeight: "900" }).setOrigin(0.5);
            this.drawFraction(x+85, y, q.n2, q.d2);
        };
    </script>
</body>
</html>